# GitOps Showcase

A demonstration of GitOps principles using GitHub Actions, Terraform, GKE, and Flux.

## Architecture

```
GitHub Actions (Terraform)
         │
         ▼
    GKE Cluster
    (e2-standard-2)
         │
         ├── monitoring namespace (Terraform)
         │
         ▼
       Flux ──────► kubernetes/apps/
         │
         ▼
  Prometheus + Grafana
```

## Architecture Principles

| Layer | Managed By | Resources |
|-------|------------|-----------|
| Cloud Infrastructure | Terraform | GKE cluster, node pools, IAM |
| Kubernetes Infrastructure | Terraform | Namespaces |
| Applications | Flux | HelmReleases, HelmRepositories |

## Manual Setup (one-time, ~10 minutes)

Everything below is done in the browser - no local tools needed.

### 1. Create GCP Project

1. Go to [GCP Console](https://console.cloud.google.com)
2. Create a new project (or use existing)
3. Note your **Project ID**

### 2. Enable Billing

1. Go to [Billing](https://console.cloud.google.com/billing)
2. Link a billing account to your project

### 3. Create Service Account

1. Go to [IAM & Admin → Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts)
2. Click **Create Service Account**
3. Name: `github-actions`
4. Click **Create and Continue**
5. Add these roles:
   - `Editor` (or for least privilege: Storage Admin, Kubernetes Engine Admin, Compute Admin, Service Account User)
6. Click **Done**
7. Click on the created service account
8. Go to **Keys** tab → **Add Key** → **Create new key** → **JSON**
9. Save the downloaded JSON file

### 4. Create GitHub PAT

1. Go to [GitHub Settings → Tokens](https://github.com/settings/tokens)
2. **Generate new token (classic)**
3. Select scope: `repo`
4. Copy the token

### 5. Add GitHub Secrets

In your repository → **Settings** → **Secrets and variables** → **Actions**, add:

| Secret | Value |
|--------|-------|
| `GCP_PROJECT_ID` | Your GCP project ID |
| `GCP_REGION` | `europe-west1` |
| `GCP_SA_KEY` | Contents of the JSON key file |
| `FLUX_GITHUB_TOKEN` | GitHub PAT from step 4 |

### 6. Deploy

1. Go to **Actions** tab
2. Select **Terraform Deploy**
3. Click **Run workflow**
4. Select `apply`
5. Click **Run workflow**

**Done!** The workflow will:
- Enable GCP APIs
- Create GCS bucket for state
- Create GKE cluster with managed node pool
- Create monitoring namespace
- Install Flux
- Deploy Prometheus + Grafana

## What Gets Created

| Component | Created By | Details |
|-----------|------------|---------|
| GCP APIs | Terraform (bootstrap job) | compute, container, storage, iam |
| GCS Bucket | gcloud (deploy job) | Terraform state backend |
| GKE Cluster | Terraform | Managed node pool, e2-standard-2 |
| Namespaces | Terraform | monitoring namespace |
| Flux | Terraform | source, kustomize, helm controllers |
| Prometheus | Flux (GitOps) | HelmRelease in monitoring namespace |
| Grafana | Flux (GitOps) | HelmRelease in monitoring namespace |

## Usage

### Access Grafana

```bash
# Get kubeconfig (run in Cloud Shell or locally)
gcloud container clusters get-credentials gitops-showcase \
  --zone europe-west1-b \
  --project YOUR_PROJECT_ID

# Get Grafana external IP
kubectl get svc -n monitoring grafana
```

Login: `admin` / `gitops-showcase`

### Demonstrate GitOps

1. Edit `kubernetes/apps/prometheus/helmrelease.yaml`
2. Change `server.replicaCount` from `1` to `2`
3. Commit and push to main
4. Watch Flux apply the change (~1 minute)

### Teardown

1. Go to **Actions** → **Terraform Destroy**
2. Click **Run workflow**
3. Type `yes-destroy`
4. Click **Run workflow**

## Cost

| Resource | Cost |
|----------|------|
| GKE cluster (1 zonal) | Free tier |
| 1x e2-standard-2 node | ~$49/month |
| GCS bucket | ~$0.02/month |

**Remember to destroy when done!**

## Repository Structure

```
.
├── .github/workflows/
│   ├── terraform-deploy.yml    # Bootstrap + Deploy
│   └── terraform-destroy.yml   # Destroy
├── terraform/
│   ├── bootstrap/              # APIs only
│   ├── main.tf                 # GKE cluster, node pool, namespaces
│   ├── flux.tf                 # Flux bootstrap
│   └── versions.tf             # Providers
├── kubernetes/
│   ├── kustomization.yaml      # Root: flux-system + apps
│   ├── flux-system/            # Auto-generated by Flux
│   └── apps/
│       ├── kustomization.yaml  # Aggregates prometheus + grafana
│       ├── prometheus/
│       │   ├── helmrepository.yaml
│       │   ├── helmrelease.yaml
│       │   └── kustomization.yaml
│       └── grafana/
│           ├── helmrepository.yaml
│           ├── helmrelease.yaml
│           └── kustomization.yaml
└── README.md
```

## License

MIT
